<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Cesium</title>
		<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
		<link
			href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
			rel="stylesheet"
		/>
		<style>
			#cesiumContainer {
				position: absolute;
				top: 0;
				left: 0;
				height: 100%;
				width: 100%;
				margin: 0;
				overflow: hidden;
				padding: 0;
				font-family: sans-serif;
			}
			html {
				height: 100%;
			}
			body {
				padding: 0;
				margin: 0;
				overflow: hidden;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="cesiumContainer"></div>
		<script>
			function createCustomShader() {
				const customShader = new Cesium.CustomShader({
					fragmentShaderText: `
						void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material) {
							int featureId = fsInput.featureIds.featureId_0;

							material.diffuse *= vec3(
								fract(sin(float(featureId)) * 43758.5453),
								fract(sin(float(featureId + 1)) * 43758.5453),
								fract(sin(float(featureId + 2)) * 43758.5453)
							);
						}
					`,
				});
				return customShader;
			}

			Cesium.Ion.defaultAccessToken =
				"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2UyMjcwOS00MDY1LTQxYjEtYjZjMy00YTU0ZTg5MmViYWQiLCJpZCI6ODAzMDYsImlhdCI6MTY0Mjc0ODI2MX0.dkwAL1CcljUV7NA7fDbhXXnmyZQU_c-G5zRx8PtEcxE";

			async function setup() {
				const viewer = new Cesium.Viewer("cesiumContainer", {
					terrainProvider: await Cesium.CesiumTerrainProvider.fromIonAssetId(
						770371,
						{ requestVertexNormals: true }
					),
					shadows: true,
				});

				viewer.extend(Cesium.viewerCesium3DTilesInspectorMixin);

				const tileset = await Cesium.Cesium3DTileset.fromUrl(
					"/examples/ext_structural_metadata/tileset.json"
				);
				viewer.scene.primitives.add(tileset);
				viewer.zoomTo(tileset);

				// let currentActiveFeatureIdLabel = 0;
				// tileset.featureIdLabel = currentActiveFeatureIdLabel;

				function createTooltip() {
					const tooltip = document.createElement("div");
					viewer.container.appendChild(tooltip);
					tooltip.style.backgroundColor = "white";
					tooltip.style.position = "absolute";
					tooltip.style.left = "0";
					tooltip.style.top = "0";
					tooltip.style.padding = "14px";
					tooltip.style["pointer-events"] = "none";
					tooltip.style["block-size"] = "fit-content";
					return tooltip;
				}
				const tooltip = createTooltip();

				function showTooltip(screenX, screenY, htmlContent) {
					tooltip.style.display = "block";
					tooltip.style.left = `${screenX}px`;
					tooltip.style.top = `${screenY}px`;
					tooltip.innerHTML = htmlContent;
				}

				function createFeatureHtml(title, feature) {
					if (!Cesium.defined(feature)) {
						return `(No ${title})<br>`;
					}
					const propertyKeys = feature.getPropertyIds();
					if (!Cesium.defined(propertyKeys)) {
						return `(No properties for ${title})<br>`;
					}
					const featureId = feature.featureId;
					let html = `<b>${title}:</b><br>`;
					html += `<b>feature_id: ${featureId}:</b><br>`;
					for (let i = 0; i < propertyKeys.length; i++) {
						const propertyKey = propertyKeys[i];
						const propertyValue = feature.getProperty(propertyKey);
						html += `&nbsp;&nbsp;${propertyKey} : ${propertyValue}<br>`;
					}
					return html;
				}

				function obtainFeature(picked) {
					if (!Cesium.defined(picked)) {
						return undefined;
					}
					const isFeature = picked instanceof Cesium.Cesium3DTileFeature;
					if (!isFeature) {
						return undefined;
					}
					return picked;
				}

				const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
				handler.setInputAction(function (movement) {
					let tooltipText = "";
					const picked = viewer.scene.pick(movement.endPosition);

					const feature = obtainFeature(picked);
					tooltipText += createFeatureHtml("Feature", feature);

					const screenX = movement.endPosition.x;
					const screenY = movement.endPosition.y;
					showTooltip(screenX, screenY, tooltipText);
				}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
			}
			setup();
		</script>
	</body>
</html>
